# Phase 1: ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ - è¦–è¦šçš„ãƒ­ã‚¸ãƒƒã‚¯å›³ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

## ğŸ“Š ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Application Layer                     â”‚
â”‚                   (SQL Queries, DML/DDL)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Transaction Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Tx (Transaction)                         â”‚  â”‚
â”‚  â”‚  â€¢ getInt/getString()  â†’ sLock() â†’ Read              â”‚  â”‚
â”‚  â”‚  â€¢ setInt/setString()  â†’ xLock() â†’ Write             â”‚  â”‚
â”‚  â”‚  â€¢ commit()            â†’ release()                    â”‚  â”‚
â”‚  â”‚  â€¢ rollback()          â†’ release()                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                                          â”‚
â”‚                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           LockManager (per Tx)                        â”‚  â”‚
â”‚  â”‚  â€¢ sLock(block, txNum)                               â”‚  â”‚
â”‚  â”‚  â€¢ xLock(block, txNum)                               â”‚  â”‚
â”‚  â”‚  â€¢ release(txNum)  - Release ALL locks               â”‚  â”‚
â”‚  â”‚  â€¢ Tracks: Set<BlockId> per transaction              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Lock Management Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          LockTable (Global, Singleton)                â”‚  â”‚
â”‚  â”‚  â€¢ ConcurrentHashMap<BlockId, Lock>                  â”‚  â”‚
â”‚  â”‚  â€¢ Timeout: 10 seconds (default)                     â”‚  â”‚
â”‚  â”‚  â€¢ Thread-safe                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                                          â”‚
â”‚                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Lock (per Block)                         â”‚  â”‚
â”‚  â”‚  â€¢ Set<Integer> sharedHolders                        â”‚  â”‚
â”‚  â”‚  â€¢ int exclusiveHolder                               â”‚  â”‚
â”‚  â”‚  â€¢ Queue<LockRequest> waitQueue (FIFO)               â”‚  â”‚
â”‚  â”‚  â€¢ ReentrantLock + Condition (wait/notify)           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Storage Layer                           â”‚
â”‚            (BlockId, Buffer, Page, FileMgr)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ãƒ­ãƒƒã‚¯å–å¾—ãƒ•ãƒ­ãƒ¼ï¼ˆã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ï¼‰

### ã‚±ãƒ¼ã‚¹ 1: å…±æœ‰ãƒ­ãƒƒã‚¯å–å¾— (Read)

```
Tx1              LockManager        LockTable          Lock
 â”‚                    â”‚                 â”‚                â”‚
 â”‚â”€â”€getInt(blk)â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                â”‚
 â”‚                    â”‚â”€â”€sLock(blk,1)â”€â”€>â”‚                â”‚
 â”‚                    â”‚                 â”‚â”€â”€getLock(blk)â”€>â”‚
 â”‚                    â”‚                 â”‚                â”‚
 â”‚                    â”‚                 â”‚<â”€â”€â”€new Lock()â”€â”€â”‚
 â”‚                    â”‚                 â”‚                â”‚
 â”‚                    â”‚                 â”‚â”€â”€sLock(1)â”€â”€â”€â”€â”€>â”‚
 â”‚                    â”‚                 â”‚                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚                    â”‚                 â”‚                â”‚ â”‚ Check:          â”‚
 â”‚                    â”‚                 â”‚                â”‚ â”‚ - No X-Lock?    â”‚
 â”‚                    â”‚                 â”‚                â”‚ â”‚ - Queue FIFO?   â”‚
 â”‚                    â”‚                 â”‚                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â”‚                    â”‚                 â”‚                â”‚
 â”‚                    â”‚                 â”‚<â”€â”€SUCCESSâ”€â”€â”€â”€â”€â”€â”‚
 â”‚                    â”‚                 â”‚                â”‚ (Add to sharedHolders)
 â”‚                    â”‚<â”€â”€SUCCESSâ”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
 â”‚                    â”‚                                  â”‚
 â”‚                    â”‚ (Record: Tx1 holds lock on blk)  â”‚
 â”‚<â”€â”€â”€LOCKEDâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                  â”‚
 â”‚                                                        â”‚
 â”‚â”€â”€Read Dataâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
 â”‚<â”€â”€Dataâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### ã‚±ãƒ¼ã‚¹ 2: æ’ä»–ãƒ­ãƒƒã‚¯å–å¾— (Write)

```
Tx1              LockManager        LockTable          Lock
 â”‚                    â”‚                 â”‚                â”‚
 â”‚â”€â”€setInt(blk)â”€â”€â”€â”€â”€â”€>â”‚                 â”‚                â”‚
 â”‚                    â”‚â”€â”€xLock(blk,1)â”€â”€>â”‚                â”‚
 â”‚                    â”‚                 â”‚â”€â”€getLock(blk)â”€>â”‚
 â”‚                    â”‚                 â”‚                â”‚
 â”‚                    â”‚                 â”‚â”€â”€xLock(1)â”€â”€â”€â”€â”€>â”‚
 â”‚                    â”‚                 â”‚                â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚                    â”‚                 â”‚                â”‚ â”‚ Check:          â”‚
 â”‚                    â”‚                 â”‚                â”‚ â”‚ - No S-Lock?    â”‚
 â”‚                    â”‚                 â”‚                â”‚ â”‚ - No X-Lock?    â”‚
 â”‚                    â”‚                 â”‚                â”‚ â”‚ - Queue FIFO?   â”‚
 â”‚                    â”‚                 â”‚                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 â”‚                    â”‚                 â”‚                â”‚
 â”‚                    â”‚                 â”‚<â”€â”€SUCCESSâ”€â”€â”€â”€â”€â”€â”‚
 â”‚                    â”‚                 â”‚                â”‚ (Set exclusiveHolder=1)
 â”‚                    â”‚<â”€â”€SUCCESSâ”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
 â”‚                    â”‚                                  â”‚
 â”‚<â”€â”€â”€LOCKEDâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                  â”‚
 â”‚                                                        â”‚
 â”‚â”€â”€Write Dataâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
 â”‚<â”€â”€ACKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### ã‚±ãƒ¼ã‚¹ 3: ãƒ­ãƒƒã‚¯ç«¶åˆã¨ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°

```
Tx1         Tx2         Lock (Block A)           Timeline
 â”‚           â”‚                 â”‚                     â”‚
 â”‚â”€â”€xLockâ”€â”€â”€>â”‚                 â”‚                     â”‚ T0
 â”‚           â”‚                 â”‚<â”€ exclusiveHolder=1 â”‚
 â”‚<â”€â”€OKâ”€â”€â”€â”€â”€â”€â”‚                 â”‚                     â”‚
 â”‚           â”‚                 â”‚                     â”‚
 â”‚           â”‚â”€â”€xLockâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚ T1
 â”‚           â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
 â”‚           â”‚                 â”‚ â”‚ WAIT         â”‚   â”‚
 â”‚           â”‚    BLOCKED      â”‚ â”‚ (in queue)   â”‚   â”‚
 â”‚           â”‚    ......       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
 â”‚           â”‚                 â”‚                     â”‚
 â”‚â”€â”€commit()â”€>                 â”‚                     â”‚ T2
 â”‚           â”‚                 â”‚                     â”‚
 â”‚â”€â”€release()>                 â”‚                     â”‚
 â”‚           â”‚                 â”‚<â”€ exclusiveHolder=-1â”‚
 â”‚           â”‚                 â”‚    condition.signalAll()
 â”‚           â”‚                 â”‚                     â”‚
 â”‚           â”‚<â”€ACQUIREDâ”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚ T3
 â”‚           â”‚                 â”‚<â”€ exclusiveHolder=2 â”‚
 â”‚           â”‚                 â”‚                     â”‚
```

---

## ğŸ” ãƒ­ãƒƒã‚¯äº’æ›æ€§ãƒãƒˆãƒªã‚¯ã‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Existing  â”‚   SHARED     â”‚  EXCLUSIVE   â”‚
â”‚   Request   â”‚   (S-Lock)   â”‚  (X-Lock)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   SHARED    â”‚      âœ…      â”‚      âŒ      â”‚
â”‚   (S-Lock)  â”‚   Compatible â”‚   BLOCKED    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  EXCLUSIVE  â”‚      âŒ      â”‚      âŒ      â”‚
â”‚   (X-Lock)  â”‚   BLOCKED    â”‚   BLOCKED    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ä¾‹:
â€¢ åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³: S-Lock â†’ X-Lock (ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å¯èƒ½)
â€¢ åŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³: åŒã˜ãƒ­ãƒƒã‚¯ã®å†å–å¾— (å†ªç­‰æ€§)
```

---

## ğŸ”„ ãƒ­ãƒƒã‚¯çŠ¶æ…‹é·ç§»å›³

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”€â”€â”€â”€>â”‚  UNLOCKED    â”‚<â”€â”€â”€â”€
                    â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                    â”‚           â”‚            â”‚
                    â”‚           â”‚ sLock()    â”‚
                    â”‚           â–¼            â”‚
                    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                    â”‚    â”‚  S-LOCKED    â”‚    â”‚
    unlock()        â”‚    â”‚ (Multiple Tx)â”‚    â”‚ unlock()
    (last holder)   â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ (exclusive holder)
                    â”‚           â”‚            â”‚
                    â”‚           â”‚ xLock()    â”‚
                    â”‚           â”‚ (upgrade)  â”‚
                    â”‚           â–¼            â”‚
                    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                    â”€â”€â”€â”€>â”‚  X-LOCKED    â”‚â”€â”€â”€â”€
                         â”‚ (Single Tx)  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çŠ¶æ…‹: UNLOCKED
  â€¢ sharedHolders: empty
  â€¢ exclusiveHolder: -1
  
çŠ¶æ…‹: S-LOCKED
  â€¢ sharedHolders: {Tx1, Tx2, ...}
  â€¢ exclusiveHolder: -1
  
çŠ¶æ…‹: X-LOCKED
  â€¢ sharedHolders: empty
  â€¢ exclusiveHolder: TxN
```

---

## ğŸš¦ Strict 2PL (Two-Phase Locking) ãƒ—ãƒ­ãƒˆã‚³ãƒ«

```
Transaction Lifecycle
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GROWING PHASE                      â”‚
â”‚                  (ãƒ­ãƒƒã‚¯å–å¾—ãƒ•ã‚§ãƒ¼ã‚º)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  BEGIN TRANSACTION (Tx.constructor)                  â”‚
â”‚      â”‚                                                â”‚
â”‚      â”œâ”€> getInt()  â”€â”€> sLock()   â”                  â”‚
â”‚      â”œâ”€> setInt()  â”€â”€> xLock()   â”‚ Accumulating     â”‚
â”‚      â”œâ”€> getString()â”€â”€> sLock()  â”‚ Locks            â”‚
â”‚      â”œâ”€> setString()â”€â”€> xLock()  â”˜                  â”‚
â”‚      â”‚                                                â”‚
â”‚      â”‚  (ãƒ­ãƒƒã‚¯ã¯è§£æ”¾ã—ãªã„)                          â”‚
â”‚      â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SHRINKING PHASE                     â”‚
â”‚                  (ãƒ­ãƒƒã‚¯è§£æ”¾ãƒ•ã‚§ãƒ¼ã‚º)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       â”‚
â”‚  COMMIT / ROLLBACK                                   â”‚
â”‚      â”‚                                                â”‚
â”‚      â””â”€> lockMgr.release(txNum)                      â”‚
â”‚              â”‚                                        â”‚
â”‚              â””â”€> ã™ã¹ã¦ã®ãƒ­ãƒƒã‚¯ã‚’ä¸€æ‹¬è§£æ”¾              â”‚
â”‚                                                       â”‚
â”‚  END TRANSACTION                                     â”‚
â”‚                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Strict 2PL ã®ç‰¹å¾´:
âœ… ã™ã¹ã¦ã®ãƒ­ãƒƒã‚¯ã¯ COMMIT/ROLLBACK æ™‚ã«ä¸€æ‹¬è§£æ”¾
âœ… Serializability (ç›´åˆ—åŒ–å¯èƒ½æ€§) ã‚’ä¿è¨¼
âœ… Dirty Read ã‚’å®Œå…¨ã«é˜²æ­¢
```

---

## ğŸ›¡ï¸ ä¸¦è¡Œæ€§åˆ¶å¾¡ã®ä¾‹

### ä¾‹ 1: Lost Update é˜²æ­¢

```
Time   Tx1 (balance=100)          Tx2 (balance=100)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 T0    BEGIN                      BEGIN
 T1    READ balance               â”‚
       xLock(block)                â”‚
       balance = 100               â”‚
 T2    â”‚                           READ balance (BLOCKED)
       â”‚                           xLock(block) - WAIT...
 T3    balance = balance + 50     â”‚
       WRITE balance=150           â”‚
 T4    COMMIT                      â”‚
       release()                   â”‚
 T5    â”‚                           â”‚ (Lock acquired)
       â”‚                           balance = 100 âŒ (å¤ã„å€¤)
 T6    â”‚                           balance = balance + 30
       â”‚                           WRITE balance=130 âŒ
 T7    â”‚                           COMMIT

âŒ Without Lock: Final balance = 130 (Lost Tx1's +50)
âœ… With Lock:    Tx2 is BLOCKED until Tx1 commits
                 Tx2 reads balance=150, writes 180 âœ…
```

### ä¾‹ 2: Dirty Read é˜²æ­¢

```
Time   Tx1                         Tx2
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 T0    BEGIN                       BEGIN
 T1    READ balance=100            â”‚
       xLock(block)                 â”‚
 T2    WRITE balance=200           â”‚
       (uncommitted)                â”‚
 T3    â”‚                            READ balance (BLOCKED)
       â”‚                            sLock(block) - WAIT...
 T4    ROLLBACK âŒ                  â”‚
       balance=100 (restored)       â”‚
       release()                    â”‚
 T5    â”‚                            â”‚ (Lock acquired)
       â”‚                            READ balance=100 âœ…

âœ… Tx2 never sees uncommitted value (200)
âœ… Tx2 only reads committed value (100)
```

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

### ãƒ­ãƒƒã‚¯ç²’åº¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Lock Granularity Spectrum                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  DATABASE LEVEL  (Coarse)                         â”‚
â”‚       â†“                                            â”‚
â”‚  TABLE LEVEL                                       â”‚
â”‚       â†“                                            â”‚
â”‚  BLOCK LEVEL  â† ç¾åœ¨ã®å®Ÿè£…                         â”‚
â”‚       â†“                                            â”‚
â”‚  RECORD LEVEL  (Fine) â† å°†æ¥ã®æ‹¡å¼µ                 â”‚
â”‚                                                    â”‚
â”‚  Trade-offs:                                       â”‚
â”‚  â€¢ Coarse: ä½ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã€ä½ä¸¦è¡Œæ€§              â”‚
â”‚  â€¢ Fine:   é«˜ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã€é«˜ä¸¦è¡Œæ€§              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯

```
Current Implementation:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Timeout-based Deadlock Prevention    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Default: 10 seconds                â”‚
â”‚  â€¢ LockAbortException on timeout      â”‚
â”‚  â€¢ Application must retry             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Future Enhancement (Phase 1 Week 2):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Wait-For Graph Deadlock Detection    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ Periodic cycle detection           â”‚
â”‚  â€¢ Automatic victim selection         â”‚
â”‚  â€¢ Automatic rollback                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä½¿ç”¨ä¾‹

### åŸºæœ¬çš„ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

```java
// ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
Tx tx = new Tx(fm, bm, log, logDir);
BlockId blk = new BlockId("students.tbl", 0);

// èª­ã¿å–ã‚Š (å…±æœ‰ãƒ­ãƒƒã‚¯è‡ªå‹•å–å¾—)
int score = tx.getInt(blk, 4);  // â†’ sLock(blk)

// æ›¸ãè¾¼ã¿ (æ’ä»–ãƒ­ãƒƒã‚¯è‡ªå‹•å–å¾—)
tx.setInt(blk, 4, score + 10);  // â†’ xLock(blk) (upgrade)

// ã‚³ãƒŸãƒƒãƒˆ (ã™ã¹ã¦ã®ãƒ­ãƒƒã‚¯ã‚’è§£æ”¾)
tx.commit();  // â†’ lockMgr.release(txId)
```

### ä¸¦è¡Œãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

```java
// Thread 1
Thread t1 = new Thread(() -> {
    Tx tx1 = new Tx(fm, bm, log, logDir);
    tx1.setInt(blk, 0, 100);  // X-Lock
    Thread.sleep(100);
    tx1.commit();             // Release
});

// Thread 2
Thread t2 = new Thread(() -> {
    Tx tx2 = new Tx(fm, bm, log, logDir);
    tx2.setInt(blk, 0, 200);  // BLOCKED (Waits for tx1)
    tx2.commit();
});

t1.start();
t2.start();
// Result: Sequential execution guaranteed âœ…
```

---

## âœ… ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

### å˜ä½“ãƒ†ã‚¹ãƒˆ
- âœ… LockTest (10 tests)
  - å…±æœ‰ãƒ­ãƒƒã‚¯ / æ’ä»–ãƒ­ãƒƒã‚¯å–å¾—
  - ãƒ­ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
  - å†ªç­‰æ€§
  - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
  - ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å‹•ä½œ

- âœ… LockTableTest (6 tests)
  - ç‹¬ç«‹ã—ãŸãƒ–ãƒ­ãƒƒã‚¯ç®¡ç†
  - ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•æ€§

- âœ… LockManagerTest (9 tests)
  - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ¯ã®è¿½è·¡
  - ä¸€æ‹¬è§£æ”¾
  - è¤‡æ•°ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

### ä¸¦è¡Œãƒ†ã‚¹ãƒˆ
- âœ… ConcurrencyTest (5 tests)
  - Lost Update é˜²æ­¢
  - Dirty Read é˜²æ­¢
  - Non-Repeatable Read
  - ãƒ­ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
  - ä¸¦è¡Œã‚¢ã‚¯ã‚»ã‚¹

---

## ğŸ”§ è¨­å®šã¨ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

### LockTable ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

```java
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10ç§’
LockTable lockTable = new LockTable();

// ã‚«ã‚¹ã‚¿ãƒ : 5ç§’
LockTable lockTable = new LockTable(5000);

// çŸ­ã„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (ãƒ†ã‚¹ãƒˆç”¨)
LockTable lockTable = new LockTable(500);
```

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```
ç—‡çŠ¶: LockAbortException (ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ)
åŸå› :
  1. ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯
  2. é•·æ™‚é–“ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
  3. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŒçŸ­ã™ãã‚‹

å¯¾ç­–:
  1. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’çŸ­ãä¿ã¤
  2. ãƒ­ãƒƒã‚¯é †åºã‚’çµ±ä¸€
  3. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’èª¿æ•´
  4. ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯æ¤œå‡ºæ©Ÿèƒ½ã®è¿½åŠ  (Phase 1 Week 2)
```

---

**ä½œæˆæ—¥**: 2025-11-16  
**ãƒ–ãƒ©ãƒ³ãƒ**: `feature/phase1-locking`  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 1 Week 1 å®Œäº† âœ…
